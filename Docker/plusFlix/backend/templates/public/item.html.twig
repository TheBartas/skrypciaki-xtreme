{% extends "search/base.html.twig" %}

{% block title %}
    Item Page
{% endblock %}


{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/public_item.css') }}">
{% endblock %}

{% block body %}
    <div id="main_content">
        <div id="leftColumn">
            <div class="bigPoster">
                <img src="https://tvod.iat.pl/view/img/notfound_portrait.jpg">
            </div>

            <div id="itemTags">
                {% for tag in item.tags %}
                    <div class="tag">
                        {{ tag.tagName }}
                    </div>
                {% endfor %}
            </div>
        </div>

        <div id="middleColumn">
            <h1>{{ item.name }}</h1>
            <p>
                {{ item.type == 1 ? "Film" : "Serial" }}
                |
                {{ item.year }}
            </p><br>

            <h2>Reżyser</h2>
            <p> {{ item.director }} </p><br>

            <h2>Kategorie</h2>
            <p>
                {% for category in item.categories %}
                    {{ category.genre }}
                    {% if not loop.last %},{% endif %}
                {% endfor %}
            </p><br>

            <h2>Opis</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam eget lorem venenatis, accumsan odio ac, fermentum ligula. Phasellus pulvinar aliquet nisi, eget ultrices nunc laoreet id. Nullam finibus mi ultricies, euismod ligula gravida, tincidunt ante. Donec tempus metus et eros vehicula, sit amet dictum purus dictum. Duis porta bibendum velit consectetur elementum. Donec placerat turpis feugiat, faucibus odio tincidunt, aliquet enim. Proin nec diam dignissim, eleifend lacus non, molestie eros. Etiam ac massa tristique, semper elit eu, aliquet erat. Maecenas auctor felis justo, vitae dictum nibh suscipit ut. In id lacinia justo. Donec in molestie lectus. Vivamus eu lacus id eros cursus accumsan. Nullam nibh massa, aliquet id aliquet non, posuere sed enim. Sed augue justo, blandit a sem a, tempus sollicitudin mi. Phasellus non ante vel justo malesuada tempor id ultricies neque. </p><br>

            <button id="add-to-favorites" class="fav-btn" data-id="{{ item.id }}">⊕ Dodaj do ulubionych</button>

            <h2>Gdzie obejrzeć</h2>

            <div id="streamingsContainer">
                {% for streaming in item.streamings %}
                <div class="streaming">
                        {{ streaming.platformName }}
                </div>
                {% endfor %}
            </div>

            <div id="ratingSection">
                <h2>Komentarze</h2>

                {% for rating in item.ratings %}
                    <div class="rating">
                        <div id="score-container-small">
                            <span class="star-symbol-rating" >{% if 1 <= rating.rating %}&starf;{% else %}&star;{% endif %}</span>
                            <span class="star-symbol-rating" >{% if 2 <= rating.rating %}&starf;{% else %}&star;{% endif %}</span>
                            <span class="star-symbol-rating" >{% if 3 <= rating.rating %}&starf;{% else %}&star;{% endif %}</span>
                            <span class="star-symbol-rating" >{% if 4 <= rating.rating %}&starf;{% else %}&star;{% endif %}</span>
                            <span class="star-symbol-rating" >{% if 5 <= rating.rating %}&starf;{% else %}&star;{% endif %}</span>
                        </div>
                        <p>{{ rating.comment }}</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div id="rightColumn">
            <h2>Już obejrzane?</h2>
            <div id="itemScore">
                <form id='rating-form' method="POST" action="{{ path('rating_add') }}">
                    <div id="score-container">
                        <span class="star-symbol" data-value="1">&star;</span>
                        <span class="star-symbol" data-value="2">&star;</span>
                        <span class="star-symbol" data-value="3">&star;</span>
                        <span class="star-symbol" data-value="4">&star;</span>
                        <span class="star-symbol" data-value="5">&star;</span>
                    </div>
                    <input id="commentInput" type="text" name="comment" placeholder="comment...">
                    <input type="hidden" id="scoreInput" name="rating">
                    <input type="hidden" id="itemId" name="itemId" value="{{ item.id }}">
                    <button type="submit">Dodaj</button>
                </form>
            </div>

            <h2>Podobne:</h2>
            <div id="similarItemsContainer">
                {% for similar in similars %}
                    <div class="result-card">
                        <button class="fav-btn" data-id="{{ similar.id }}">★</button>

                        <a href="{{ path('item_detail', {'id': similar.id}) }}">
                            <div class="poster-wrapper">
                                <img src="https://tvod.iat.pl/view/img/notfound_portrait.jpg" class="poster">


                                <div class="streaming-icons">
                                    {% for streaming in similar.streamings %}
                                        <img src="https://fwcdn.pl/nph/867323/2025/63747.7.jpg">
                                    {% endfor %}
                                </div>

                            </div>

                            <div class="info">
                                <h4 class="title">{{ similar.name }}</h4>
                                <p class="meta">
                                    {% if similar.type == 1 %}
                                        Film
                                    {% elseif similar.type == 2 %}
                                        Serial
                                    {% else %}
                                        Inne
                                    {% endif %}
                                    | {{ similar.year }}
                                </p>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

{% endblock %}


{% block javascript %}
    <script src="{{ asset('js/favorites.js') }}"></script>
    <script>
        // Rating
        const ratingForm = document.querySelector('#rating-form');
        const stars = document.querySelectorAll('.star-symbol');
        const scoreInput = document.getElementById('scoreInput');

        ratingForm.addEventListener('submit', e => {
            e.preventDefault(); // prevent normal page reload

            const formData = new FormData(ratingForm);

            fetch(ratingForm.action, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(`${'Rating added'}: ID`, data.id);
                        window.location.reload();
                    } else {
                        alert('Something went wrong');
                    }
                })
                .catch(err => console.error(err));
        });

        stars.forEach(star => {
            star.addEventListener('click', () => {
                const value = star.dataset.value;

                // Save score
                scoreInput.value = value;

                // Update UI
                stars.forEach(s => {
                    if(s.dataset.value <= value)
                        s.innerHTML = '&starf;';
                    else
                        s.innerHTML = '&star;';
                });
            });
        });

        // Something
        const streamingsLinks = document.querySelectorAll(".streaming");


        streamingsLinks.forEach(btn => {
            const text = btn.innerHTML.trim(); console.log(text);

            const link = document.createElement('a');
            const img = document.createElement('img');
            link.classList.add('streaming');

            if (text === "Netflix") {
                link.href = 'https://www.netflix.com';
                img.src = "https://images.ctfassets.net/4cd45et68cgf/Rx83JoRDMkYNlMC9MKzcB/2b14d5a59fc3937afd3f03191e19502d/Netflix-Symbol.png?w=700&h=456";
                img.alt = "Netflix";
            }
            else if (text === "HBO Max") {
                link.href = 'https://www.hbomax.com';
                img.src = "https://fwcdn.pl/nph/867323/2025/63747.7.jpg";
                img.alt = "HBO Max";
            }
            else if (text === "Disney+") {
                link.href = 'https://www.disneyplus.com';
                img.src = "https://platform.theverge.com/wp-content/uploads/sites/2/chorus/uploads/chorus_asset/file/25357066/Disney__Logo_March_2024.png?quality=90&strip=all&crop=7.8125%2C0%2C84.375%2C100&w=2400";
                img.alt = "Disney+";
            }
            else if (text === "Amazon Prime Video") {
                link.href = 'https://www.primevideo.com/';
                img.src = "https://upload.wikimedia.org/wikipedia/commons/c/ca/Amazon_Prime_Video_logo_%282024%29.svg";
                img.alt = "Amazon Prime Video";
            }
            else if (text === "Apple TV+") {
                link.href = 'https://tv.apple.com';
                img.src = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQs5Uv6cx7KcDlTFANEqZFj-HK0HlwpIu7Nhg&s";
                img.alt = "Apple TV+";
            }
            else if (text === "Hulu") {
                link.href = 'https://www.netflix.com';
                img.src = "https://upload.wikimedia.org/wikipedia/commons/f/f9/Hulu_logo_%282018%29.svg";
                img.alt = "Hulu";
            }


            link.append(img);
            btn.replaceWith(link);
        });
    </script>
{% endblock %}
